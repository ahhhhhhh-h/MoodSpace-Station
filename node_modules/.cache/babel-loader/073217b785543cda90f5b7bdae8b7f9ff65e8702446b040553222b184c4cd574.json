{"ast":null,"code":"/*\n * Copyright (c) AXA Group Operations Spain S.A.\n *\n * Permission is hereby granted, free of charge, to any person obtaining\n * a copy of this software and associated documentation files (the\n * \"Software\"), to deal in the Software without restriction, including\n * without limitation the rights to use, copy, modify, merge, publish,\n * distribute, sublicense, and/or sell copies of the Software, and to\n * permit persons to whom the Software is furnished to do so, subject to\n * the following conditions:\n *\n * The above copyright notice and this permission notice shall be\n * included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\n * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\n * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\nconst {\n  Clonable,\n  compareWildcars\n} = require('@nlpjs/core');\nconst {\n  SpellCheck\n} = require('@nlpjs/similarity');\nclass Nlu extends Clonable {\n  constructor(settings = {}, container) {\n    super({\n      settings: {},\n      container: settings.container || container\n    }, container);\n    this.applySettings(this.settings, settings);\n    this.applySettings(this.settings, {\n      locale: 'en'\n    });\n    if (!this.settings.tag) {\n      this.settings.tag = `nlu-${this.settings.locale}`;\n    }\n    this.registerDefault();\n    this.applySettings(this.settings, this.container.getConfiguration(this.settings.tag));\n    this.applySettings(this, {\n      pipelinePrepare: this.getPipeline(`${this.settings.tag}-prepare`),\n      pipelineTrain: this.getPipeline(`${this.settings.tag}-train`),\n      pipelineProcess: this.getPipeline(`${this.settings.tag}-process`)\n    });\n    this.spellCheck = new SpellCheck(this.settings);\n  }\n  registerDefault() {\n    this.container.registerConfiguration('nlu-??', {\n      keepStopwords: true,\n      nonefeatureValue: 1,\n      nonedeltaMultiplier: 1.2,\n      spellCheck: false,\n      spellCheckDistance: 1,\n      filterZeros: true,\n      log: true\n    }, false);\n    this.container.registerPipeline('nlu-??-train', ['.prepareCorpus', '.addNoneFeature', '.innerTrain'], false);\n  }\n  async defaultPipelinePrepare(input) {\n    let result;\n    if (this.cache) {\n      const now = new Date();\n      const diff = Math.abs(now.getTime() - this.cache.created) / 3600000;\n      if (diff > 1) {\n        this.cache.results = {};\n        this.cache.created = new Date().getTime();\n      }\n    }\n    if (!this.cache) {\n      this.cache = {\n        created: new Date().getTime(),\n        results: {},\n        normalize: this.container.get('normalize'),\n        tokenize: this.container.get('tokenize'),\n        removeStopwords: this.container.get('removeStopwords'),\n        stem: this.container.get('stem'),\n        arrToObj: this.container.get('arrToObj')\n      };\n    } else if (this.cache.results[input.settings.locale]) {\n      result = this.cache.results[input.settings.locale][input.text || input.utterance];\n      if (result) {\n        return result;\n      }\n    }\n    let output = input;\n    output = this.cache.normalize.run(output);\n    output = await this.cache.tokenize.run(output);\n    output = this.cache.removeStopwords.run(output);\n    output = await this.cache.stem.run(output);\n    output = this.cache.arrToObj.run(output);\n    result = output.tokens;\n    if (!this.cache.results[input.settings.locale]) {\n      this.cache.results[input.settings.locale] = {};\n    }\n    this.cache.results[input.settings.locale][input.text || input.utterance] = result;\n    return result;\n  }\n  async defaultPipelineProcess(input) {\n    let output = await this.prepare(input);\n    output = await this.doSpellCheck(output);\n    output = await this.textToFeatures(output);\n    output = await this.innerProcess(output);\n    output = await this.filterNonActivated(output);\n    output = await this.normalizeClassifications(output);\n    return output;\n  }\n  async prepare(text, srcSettings) {\n    const settings = srcSettings || this.settings;\n    if (typeof text === 'string') {\n      const input = {\n        locale: this.settings.locale,\n        text,\n        settings\n      };\n      if (this.pipelinePrepare) {\n        return this.runPipeline(input, this.pipelinePrepare);\n      }\n      return this.defaultPipelinePrepare(input);\n    }\n    if (typeof text === 'object') {\n      if (Array.isArray(text)) {\n        const result = [];\n        for (let i = 0; i < text.length; i += 1) {\n          result.push(await this.prepare(text[i], settings));\n        }\n        return result;\n      }\n      let item = settings.fieldNameSrc ? text[settings.fieldNameSrc] : text.texts || text.utterances;\n      if (!item && typeof item !== 'string') {\n        if (typeof text.text === 'string') {\n          item = text.text;\n        } else if (typeof text.utterance === 'string') {\n          item = text.utterance;\n        }\n      }\n      if (item || typeof item === 'string') {\n        const result = await this.prepare(item, settings);\n        const targetField = settings.fieldNameTgt || 'tokens';\n        return {\n          [targetField]: result,\n          ...text\n        };\n      }\n    }\n    throw new Error(`Error at nlu.prepare: expected a text but received ${text}`);\n  }\n  async doSpellCheck(input, srcSettings) {\n    const settings = this.applySettings(srcSettings || {}, this.settings);\n    let shouldSpellCheck = input.settings.spellCheck === undefined ? undefined : input.settings.spellCheck;\n    let spellCheckDistance = input.settings.spellCheckDistance === undefined ? undefined : input.settings.spellCheckDistance;\n    if (shouldSpellCheck === undefined) {\n      shouldSpellCheck = settings.spellCheck === undefined ? undefined : settings.spellCheck;\n    }\n    if (spellCheckDistance === undefined) {\n      spellCheckDistance = settings.spellCheckDistance === undefined ? 1 : settings.spellCheckDistance;\n    }\n    if (shouldSpellCheck) {\n      const tokens = this.spellCheck.check(input.tokens, spellCheckDistance);\n      input.tokens = tokens;\n    }\n    return input;\n  }\n  async prepareCorpus(srcInput) {\n    this.features = {};\n    this.intents = {};\n    this.intentFeatures = {};\n    const input = srcInput;\n    const {\n      corpus\n    } = input;\n    const result = [];\n    for (let i = 0; i < corpus.length; i += 1) {\n      const {\n        intent\n      } = corpus[i];\n      const item = {\n        input: await this.prepare(corpus[i].utterance, input.settings),\n        output: {\n          [intent]: 1\n        }\n      };\n      const keys = Object.keys(item.input);\n      if (!Object.prototype.hasOwnProperty.call(this.intentFeatures, intent)) {\n        this.intentFeatures[intent] = {};\n      }\n      for (let j = 0; j < keys.length; j += 1) {\n        this.features[keys[j]] = 1;\n        this.intentFeatures[intent][keys[j]] = 1;\n      }\n      this.intents[intent] = 1;\n      result.push(item);\n    }\n    const keys = Object.keys(this.intentFeatures);\n    this.featuresToIntent = {};\n    for (let i = 0; i < keys.length; i += 1) {\n      const intent = keys[i];\n      const features = Object.keys(this.intentFeatures[intent]);\n      for (let j = 0; j < features.length; j += 1) {\n        const feature = features[j];\n        if (!Object.prototype.hasOwnProperty.call(this.featuresToIntent, feature)) {\n          this.featuresToIntent[feature] = [];\n        }\n        this.featuresToIntent[feature].push(intent);\n      }\n    }\n    this.spellCheck.setFeatures(this.features);\n    this.numFeatures = Object.keys(this.features).length;\n    this.numIntents = Object.keys(this.intents).length;\n    input.corpus = result;\n    return input;\n  }\n  addNoneFeature(input) {\n    const {\n      corpus\n    } = input;\n    if (input.settings && input.settings.useNoneFeature) {\n      corpus.push({\n        input: {\n          nonefeature: 1\n        },\n        output: {\n          None: 1\n        }\n      });\n    }\n    return input;\n  }\n  convertToArray(srcInput) {\n    const input = srcInput;\n    const {\n      classifications\n    } = input;\n    if (classifications) {\n      if (!this.intentsArr) {\n        if (this.intents) {\n          this.intentsArr = Object.keys(this.intents);\n          if (!this.intents.None) {\n            this.intentsArr.push('None');\n          }\n        } else {\n          this.intentsArr = Object.keys(classifications);\n        }\n      }\n      const keys = this.intentsArr;\n      const result = [];\n      for (let i = 0; i < keys.length; i += 1) {\n        const intent = keys[i];\n        const score = classifications[intent];\n        if (score !== undefined && (score > 0 || !input.settings.filterZeros)) {\n          result.push({\n            intent,\n            score\n          });\n        }\n      }\n      if (!result.length) {\n        result.push({\n          intent: 'None',\n          score: 1\n        });\n      }\n      input.classifications = result.sort((a, b) => b.score - a.score);\n    }\n    return input;\n  }\n  someSimilar(tokensA, tokensB) {\n    for (let i = 0; i < tokensB.length; i += 1) {\n      if (tokensA[tokensB[i]]) {\n        return true;\n      }\n    }\n    return false;\n  }\n  matchAllowList(intent, allowList) {\n    for (let i = 0; i < allowList.length; i += 1) {\n      if (compareWildcars(intent, allowList[i])) {\n        return true;\n      }\n    }\n    return false;\n  }\n  intentIsActivated(intent, tokens, allowList) {\n    if (allowList) {\n      if (Array.isArray(allowList)) {\n        return this.matchAllowList(intent, allowList);\n      }\n      if (!allowList[intent]) {\n        return false;\n      }\n    }\n    const features = this.intentFeatures[intent];\n    if (!features) {\n      return false;\n    }\n    const keys = Object.keys(tokens);\n    for (let i = 0; i < keys.length; i += 1) {\n      if (features[keys[i]]) {\n        return true;\n      }\n    }\n    return false;\n  }\n  filterNonActivated(srcInput) {\n    if (this.intentFeatures && srcInput.classifications) {\n      const intents = srcInput.classifications.map(x => x.intent);\n      let someModified = false;\n      for (let i = 0; i < intents.length; i += 1) {\n        const intent = intents[i];\n        if (intent !== 'None') {\n          if (!this.intentIsActivated(intent, srcInput.tokens, srcInput.settings.allowList)) {\n            srcInput.classifications[i].score = 0;\n            someModified = true;\n          }\n        }\n      }\n      if (someModified) {\n        srcInput.classifications.sort((a, b) => b.score - a.score);\n      }\n    }\n    return srcInput;\n  }\n  normalizeClassifications(srcInput) {\n    const input = srcInput;\n    const {\n      classifications\n    } = input;\n    if (classifications) {\n      let total = 0;\n      for (let i = 0; i < classifications.length; i += 1) {\n        classifications[i].score **= 2;\n        total += classifications[i].score;\n      }\n      if (total > 0) {\n        for (let i = 0; i < classifications.length; i += 1) {\n          classifications[i].score /= total;\n        }\n      }\n    } else {\n      input.classifications = input.nluAnswer;\n    }\n    return input;\n  }\n  textToFeatures(srcInput) {\n    const input = srcInput;\n    const {\n      tokens\n    } = input;\n    const keys = Object.keys(tokens);\n    let unknownTokens = 0;\n    const features = {};\n    for (let i = 0; i < keys.length; i += 1) {\n      const token = keys[i];\n      if (token === 'nonefeature') {\n        tokens[token] = this.nonefeatureValue;\n      } else if (!this.features || !this.features[token]) {\n        unknownTokens += 1;\n      } else {\n        features[token] = tokens[token];\n      }\n    }\n    let nonedelta = input.settings.nonedeltaValue === undefined ? this.numIntents / this.numFeatures : this.settings.nonedeltaValue;\n    let nonevalue = 0;\n    for (let i = 0; i < unknownTokens; i += 1) {\n      nonevalue += nonedelta;\n      nonedelta *= this.settings.nonedeltaMultiplier;\n    }\n    if (input.settings && input.settings.useNoneFeature && nonevalue) {\n      features.nonefeature = nonevalue;\n    }\n    input.tokens = features;\n    return input;\n  }\n  async innerTrain() {\n    throw new Error('This method should be implemented by child classes');\n  }\n  async train(corpus, settings) {\n    const input = {\n      corpus,\n      settings: this.applySettings(settings, this.settings)\n    };\n    return this.runPipeline(input, this.pipelineTrain);\n  }\n  async getExplanation(input, explanation) {\n    if (!explanation) {\n      return undefined;\n    }\n    const normalized = await this.container.get('normalize').run(input);\n    const tokenized = await this.container.get('tokenize').run(normalized);\n    const {\n      tokens\n    } = tokenized;\n    const stemmed = await this.container.get('stem').run(tokenized);\n    const stems = stemmed.tokens;\n    const result = [];\n    result.push({\n      token: '',\n      stem: '##bias',\n      weight: explanation.bias\n    });\n    for (let i = 0; i < tokens.length; i += 1) {\n      const stem = stems[i];\n      result.push({\n        token: tokens[i],\n        stem,\n        weight: explanation.weights[stem]\n      });\n    }\n    return result;\n  }\n  async process(utterance, settings) {\n    const input = {\n      text: utterance,\n      settings: this.applySettings(settings || {}, this.settings)\n    };\n    let output;\n    if (this.pipelineProcess) {\n      output = await this.runPipeline(input, this.pipelineProcess);\n    } else {\n      output = await this.defaultPipelineProcess(input);\n    }\n    if (Array.isArray(output.classifications)) {\n      const explanation = input.settings.returnExplanation ? await this.getExplanation(input, output.explanation) : undefined;\n      return {\n        classifications: output.classifications,\n        entities: undefined,\n        explanation\n      };\n    }\n    if (output.intents) {\n      output.classifications = output.intents;\n      delete output.intents;\n    }\n    return output;\n  }\n  toJSON() {\n    const result = {\n      settings: {\n        ...this.settings\n      },\n      features: this.features,\n      intents: this.intents,\n      intentFeatures: this.intentFeatures,\n      featuresToIntent: this.featuresToIntent\n    };\n    delete result.settings.container;\n    return result;\n  }\n  fromJSON(json) {\n    this.applySettings(this.settings, json.settings);\n    this.features = json.features || {};\n    this.intents = json.intents || {};\n    this.intentsArr = Object.keys(json.intents);\n    this.featuresToIntent = json.featuresToIntent || {};\n    this.intentFeatures = json.intentFeatures || {};\n    this.spellCheck.setFeatures(this.features);\n    this.numFeatures = Object.keys(this.features).length;\n    this.numIntents = Object.keys(this.intents).length;\n  }\n}\nmodule.exports = Nlu;","map":{"version":3,"names":["Clonable","compareWildcars","require","SpellCheck","Nlu","constructor","settings","container","applySettings","locale","tag","registerDefault","getConfiguration","pipelinePrepare","getPipeline","pipelineTrain","pipelineProcess","spellCheck","registerConfiguration","keepStopwords","nonefeatureValue","nonedeltaMultiplier","spellCheckDistance","filterZeros","log","registerPipeline","defaultPipelinePrepare","input","result","cache","now","Date","diff","Math","abs","getTime","created","results","normalize","get","tokenize","removeStopwords","stem","arrToObj","text","utterance","output","run","tokens","defaultPipelineProcess","prepare","doSpellCheck","textToFeatures","innerProcess","filterNonActivated","normalizeClassifications","srcSettings","runPipeline","Array","isArray","i","length","push","item","fieldNameSrc","texts","utterances","targetField","fieldNameTgt","Error","shouldSpellCheck","undefined","check","prepareCorpus","srcInput","features","intents","intentFeatures","corpus","intent","keys","Object","prototype","hasOwnProperty","call","j","featuresToIntent","feature","setFeatures","numFeatures","numIntents","addNoneFeature","useNoneFeature","nonefeature","None","convertToArray","classifications","intentsArr","score","sort","a","b","someSimilar","tokensA","tokensB","matchAllowList","allowList","intentIsActivated","map","x","someModified","total","nluAnswer","unknownTokens","token","nonedelta","nonedeltaValue","nonevalue","innerTrain","train","getExplanation","explanation","normalized","tokenized","stemmed","stems","weight","bias","weights","process","returnExplanation","entities","toJSON","fromJSON","json","module","exports"],"sources":["/Users/zyq/Desktop/大二下/暑期实习/moonshot project/node_modules/@nlpjs/nlu/src/nlu.js"],"sourcesContent":["/*\n * Copyright (c) AXA Group Operations Spain S.A.\n *\n * Permission is hereby granted, free of charge, to any person obtaining\n * a copy of this software and associated documentation files (the\n * \"Software\"), to deal in the Software without restriction, including\n * without limitation the rights to use, copy, modify, merge, publish,\n * distribute, sublicense, and/or sell copies of the Software, and to\n * permit persons to whom the Software is furnished to do so, subject to\n * the following conditions:\n *\n * The above copyright notice and this permission notice shall be\n * included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\n * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\n * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\nconst { Clonable, compareWildcars } = require('@nlpjs/core');\nconst { SpellCheck } = require('@nlpjs/similarity');\n\nclass Nlu extends Clonable {\n  constructor(settings = {}, container) {\n    super(\n      {\n        settings: {},\n        container: settings.container || container,\n      },\n      container\n    );\n    this.applySettings(this.settings, settings);\n    this.applySettings(this.settings, { locale: 'en' });\n    if (!this.settings.tag) {\n      this.settings.tag = `nlu-${this.settings.locale}`;\n    }\n    this.registerDefault();\n    this.applySettings(\n      this.settings,\n      this.container.getConfiguration(this.settings.tag)\n    );\n    this.applySettings(this, {\n      pipelinePrepare: this.getPipeline(`${this.settings.tag}-prepare`),\n      pipelineTrain: this.getPipeline(`${this.settings.tag}-train`),\n      pipelineProcess: this.getPipeline(`${this.settings.tag}-process`),\n    });\n    this.spellCheck = new SpellCheck(this.settings);\n  }\n\n  registerDefault() {\n    this.container.registerConfiguration(\n      'nlu-??',\n      {\n        keepStopwords: true,\n        nonefeatureValue: 1,\n        nonedeltaMultiplier: 1.2,\n        spellCheck: false,\n        spellCheckDistance: 1,\n        filterZeros: true,\n        log: true,\n      },\n      false\n    );\n    this.container.registerPipeline(\n      'nlu-??-train',\n      ['.prepareCorpus', '.addNoneFeature', '.innerTrain'],\n      false\n    );\n  }\n\n  async defaultPipelinePrepare(input) {\n    let result;\n    if (this.cache) {\n      const now = new Date();\n      const diff = Math.abs(now.getTime() - this.cache.created) / 3600000;\n      if (diff > 1) {\n        this.cache.results = {};\n        this.cache.created = new Date().getTime();\n      }\n    }\n    if (!this.cache) {\n      this.cache = {\n        created: new Date().getTime(),\n        results: {},\n        normalize: this.container.get('normalize'),\n        tokenize: this.container.get('tokenize'),\n        removeStopwords: this.container.get('removeStopwords'),\n        stem: this.container.get('stem'),\n        arrToObj: this.container.get('arrToObj'),\n      };\n    } else if (this.cache.results[input.settings.locale]) {\n      result =\n        this.cache.results[input.settings.locale][\n          input.text || input.utterance\n        ];\n      if (result) {\n        return result;\n      }\n    }\n    let output = input;\n    output = this.cache.normalize.run(output);\n    output = await this.cache.tokenize.run(output);\n    output = this.cache.removeStopwords.run(output);\n    output = await this.cache.stem.run(output);\n    output = this.cache.arrToObj.run(output);\n    result = output.tokens;\n    if (!this.cache.results[input.settings.locale]) {\n      this.cache.results[input.settings.locale] = {};\n    }\n    this.cache.results[input.settings.locale][input.text || input.utterance] =\n      result;\n    return result;\n  }\n\n  async defaultPipelineProcess(input) {\n    let output = await this.prepare(input);\n    output = await this.doSpellCheck(output);\n    output = await this.textToFeatures(output);\n    output = await this.innerProcess(output);\n    output = await this.filterNonActivated(output);\n    output = await this.normalizeClassifications(output);\n    return output;\n  }\n\n  async prepare(text, srcSettings) {\n    const settings = srcSettings || this.settings;\n    if (typeof text === 'string') {\n      const input = {\n        locale: this.settings.locale,\n        text,\n        settings,\n      };\n      if (this.pipelinePrepare) {\n        return this.runPipeline(input, this.pipelinePrepare);\n      }\n      return this.defaultPipelinePrepare(input);\n    }\n    if (typeof text === 'object') {\n      if (Array.isArray(text)) {\n        const result = [];\n        for (let i = 0; i < text.length; i += 1) {\n          result.push(await this.prepare(text[i], settings));\n        }\n        return result;\n      }\n      let item = settings.fieldNameSrc\n        ? text[settings.fieldNameSrc]\n        : text.texts || text.utterances;\n      if (!item && typeof item !== 'string') {\n        if (typeof text.text === 'string') {\n          item = text.text;\n        } else if (typeof text.utterance === 'string') {\n          item = text.utterance;\n        }\n      }\n      if (item || typeof item === 'string') {\n        const result = await this.prepare(item, settings);\n        const targetField = settings.fieldNameTgt || 'tokens';\n        return { [targetField]: result, ...text };\n      }\n    }\n    throw new Error(\n      `Error at nlu.prepare: expected a text but received ${text}`\n    );\n  }\n\n  async doSpellCheck(input, srcSettings) {\n    const settings = this.applySettings(srcSettings || {}, this.settings);\n    let shouldSpellCheck =\n      input.settings.spellCheck === undefined\n        ? undefined\n        : input.settings.spellCheck;\n    let spellCheckDistance =\n      input.settings.spellCheckDistance === undefined\n        ? undefined\n        : input.settings.spellCheckDistance;\n    if (shouldSpellCheck === undefined) {\n      shouldSpellCheck =\n        settings.spellCheck === undefined ? undefined : settings.spellCheck;\n    }\n    if (spellCheckDistance === undefined) {\n      spellCheckDistance =\n        settings.spellCheckDistance === undefined\n          ? 1\n          : settings.spellCheckDistance;\n    }\n    if (shouldSpellCheck) {\n      const tokens = this.spellCheck.check(input.tokens, spellCheckDistance);\n      input.tokens = tokens;\n    }\n    return input;\n  }\n\n  async prepareCorpus(srcInput) {\n    this.features = {};\n    this.intents = {};\n    this.intentFeatures = {};\n    const input = srcInput;\n    const { corpus } = input;\n    const result = [];\n    for (let i = 0; i < corpus.length; i += 1) {\n      const { intent } = corpus[i];\n      const item = {\n        input: await this.prepare(corpus[i].utterance, input.settings),\n        output: { [intent]: 1 },\n      };\n      const keys = Object.keys(item.input);\n      if (!Object.prototype.hasOwnProperty.call(this.intentFeatures, intent)) {\n        this.intentFeatures[intent] = {};\n      }\n      for (let j = 0; j < keys.length; j += 1) {\n        this.features[keys[j]] = 1;\n        this.intentFeatures[intent][keys[j]] = 1;\n      }\n      this.intents[intent] = 1;\n      result.push(item);\n    }\n    const keys = Object.keys(this.intentFeatures);\n    this.featuresToIntent = {};\n    for (let i = 0; i < keys.length; i += 1) {\n      const intent = keys[i];\n      const features = Object.keys(this.intentFeatures[intent]);\n      for (let j = 0; j < features.length; j += 1) {\n        const feature = features[j];\n        if (\n          !Object.prototype.hasOwnProperty.call(this.featuresToIntent, feature)\n        ) {\n          this.featuresToIntent[feature] = [];\n        }\n        this.featuresToIntent[feature].push(intent);\n      }\n    }\n    this.spellCheck.setFeatures(this.features);\n    this.numFeatures = Object.keys(this.features).length;\n    this.numIntents = Object.keys(this.intents).length;\n    input.corpus = result;\n    return input;\n  }\n\n  addNoneFeature(input) {\n    const { corpus } = input;\n    if (input.settings && input.settings.useNoneFeature) {\n      corpus.push({ input: { nonefeature: 1 }, output: { None: 1 } });\n    }\n    return input;\n  }\n\n  convertToArray(srcInput) {\n    const input = srcInput;\n    const { classifications } = input;\n    if (classifications) {\n      if (!this.intentsArr) {\n        if (this.intents) {\n          this.intentsArr = Object.keys(this.intents);\n          if (!this.intents.None) {\n            this.intentsArr.push('None');\n          }\n        } else {\n          this.intentsArr = Object.keys(classifications);\n        }\n      }\n      const keys = this.intentsArr;\n      const result = [];\n      for (let i = 0; i < keys.length; i += 1) {\n        const intent = keys[i];\n        const score = classifications[intent];\n        if (score !== undefined && (score > 0 || !input.settings.filterZeros)) {\n          result.push({ intent, score });\n        }\n      }\n      if (!result.length) {\n        result.push({ intent: 'None', score: 1 });\n      }\n      input.classifications = result.sort((a, b) => b.score - a.score);\n    }\n    return input;\n  }\n\n  someSimilar(tokensA, tokensB) {\n    for (let i = 0; i < tokensB.length; i += 1) {\n      if (tokensA[tokensB[i]]) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  matchAllowList(intent, allowList) {\n    for (let i = 0; i < allowList.length; i += 1) {\n      if (compareWildcars(intent, allowList[i])) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  intentIsActivated(intent, tokens, allowList) {\n    if (allowList) {\n      if (Array.isArray(allowList)) {\n        return this.matchAllowList(intent, allowList);\n      }\n      if (!allowList[intent]) {\n        return false;\n      }\n    }\n    const features = this.intentFeatures[intent];\n    if (!features) {\n      return false;\n    }\n    const keys = Object.keys(tokens);\n    for (let i = 0; i < keys.length; i += 1) {\n      if (features[keys[i]]) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  filterNonActivated(srcInput) {\n    if (this.intentFeatures && srcInput.classifications) {\n      const intents = srcInput.classifications.map((x) => x.intent);\n      let someModified = false;\n      for (let i = 0; i < intents.length; i += 1) {\n        const intent = intents[i];\n        if (intent !== 'None') {\n          if (\n            !this.intentIsActivated(\n              intent,\n              srcInput.tokens,\n              srcInput.settings.allowList\n            )\n          ) {\n            srcInput.classifications[i].score = 0;\n            someModified = true;\n          }\n        }\n      }\n      if (someModified) {\n        srcInput.classifications.sort((a, b) => b.score - a.score);\n      }\n    }\n    return srcInput;\n  }\n\n  normalizeClassifications(srcInput) {\n    const input = srcInput;\n    const { classifications } = input;\n    if (classifications) {\n      let total = 0;\n      for (let i = 0; i < classifications.length; i += 1) {\n        classifications[i].score **= 2;\n        total += classifications[i].score;\n      }\n      if (total > 0) {\n        for (let i = 0; i < classifications.length; i += 1) {\n          classifications[i].score /= total;\n        }\n      }\n    } else {\n      input.classifications = input.nluAnswer;\n    }\n    return input;\n  }\n\n  textToFeatures(srcInput) {\n    const input = srcInput;\n    const { tokens } = input;\n    const keys = Object.keys(tokens);\n    let unknownTokens = 0;\n    const features = {};\n    for (let i = 0; i < keys.length; i += 1) {\n      const token = keys[i];\n      if (token === 'nonefeature') {\n        tokens[token] = this.nonefeatureValue;\n      } else if (!this.features || !this.features[token]) {\n        unknownTokens += 1;\n      } else {\n        features[token] = tokens[token];\n      }\n    }\n    let nonedelta =\n      input.settings.nonedeltaValue === undefined\n        ? this.numIntents / this.numFeatures\n        : this.settings.nonedeltaValue;\n    let nonevalue = 0;\n    for (let i = 0; i < unknownTokens; i += 1) {\n      nonevalue += nonedelta;\n      nonedelta *= this.settings.nonedeltaMultiplier;\n    }\n    if (input.settings && input.settings.useNoneFeature && nonevalue) {\n      features.nonefeature = nonevalue;\n    }\n    input.tokens = features;\n    return input;\n  }\n\n  async innerTrain() {\n    throw new Error('This method should be implemented by child classes');\n  }\n\n  async train(corpus, settings) {\n    const input = {\n      corpus,\n      settings: this.applySettings(settings, this.settings),\n    };\n    return this.runPipeline(input, this.pipelineTrain);\n  }\n\n  async getExplanation(input, explanation) {\n    if (!explanation) {\n      return undefined;\n    }\n    const normalized = await this.container.get('normalize').run(input);\n    const tokenized = await this.container.get('tokenize').run(normalized);\n    const { tokens } = tokenized;\n    const stemmed = await this.container.get('stem').run(tokenized);\n    const stems = stemmed.tokens;\n    const result = [];\n    result.push({\n      token: '',\n      stem: '##bias',\n      weight: explanation.bias,\n    });\n    for (let i = 0; i < tokens.length; i += 1) {\n      const stem = stems[i];\n      result.push({\n        token: tokens[i],\n        stem,\n        weight: explanation.weights[stem],\n      });\n    }\n    return result;\n  }\n\n  async process(utterance, settings) {\n    const input = {\n      text: utterance,\n      settings: this.applySettings(settings || {}, this.settings),\n    };\n    let output;\n    if (this.pipelineProcess) {\n      output = await this.runPipeline(input, this.pipelineProcess);\n    } else {\n      output = await this.defaultPipelineProcess(input);\n    }\n    if (Array.isArray(output.classifications)) {\n      const explanation = input.settings.returnExplanation\n        ? await this.getExplanation(input, output.explanation)\n        : undefined;\n      return {\n        classifications: output.classifications,\n        entities: undefined,\n        explanation,\n      };\n    }\n    if (output.intents) {\n      output.classifications = output.intents;\n      delete output.intents;\n    }\n    return output;\n  }\n\n  toJSON() {\n    const result = {\n      settings: { ...this.settings },\n      features: this.features,\n      intents: this.intents,\n      intentFeatures: this.intentFeatures,\n      featuresToIntent: this.featuresToIntent,\n    };\n    delete result.settings.container;\n    return result;\n  }\n\n  fromJSON(json) {\n    this.applySettings(this.settings, json.settings);\n    this.features = json.features || {};\n    this.intents = json.intents || {};\n    this.intentsArr = Object.keys(json.intents);\n    this.featuresToIntent = json.featuresToIntent || {};\n    this.intentFeatures = json.intentFeatures || {};\n    this.spellCheck.setFeatures(this.features);\n    this.numFeatures = Object.keys(this.features).length;\n    this.numIntents = Object.keys(this.intents).length;\n  }\n}\n\nmodule.exports = Nlu;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}