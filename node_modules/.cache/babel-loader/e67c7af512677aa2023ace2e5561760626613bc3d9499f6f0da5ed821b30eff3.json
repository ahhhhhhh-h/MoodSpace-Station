{"ast":null,"code":"/*\n * Copyright (c) AXA Group Operations Spain S.A.\n *\n * Permission is hereby granted, free of charge, to any person obtaining\n * a copy of this software and associated documentation files (the\n * \"Software\"), to deal in the Software without restriction, including\n * without limitation the rights to use, copy, modify, merge, publish,\n * distribute, sublicense, and/or sell copies of the Software, and to\n * permit persons to whom the Software is furnished to do so, subject to\n * the following conditions:\n *\n * The above copyright notice and this permission notice shall be\n * included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\n * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\n * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\nconst {\n  Clonable,\n  containerBootstrap\n} = require('@nlpjs/core');\nconst {\n  NluManager,\n  NluNeural\n} = require('@nlpjs/nlu');\nconst {\n  Ner,\n  ExtractorEnum,\n  ExtractorRegex,\n  ExtractorTrim,\n  ExtractorBuiltin\n} = require('@nlpjs/ner');\nconst {\n  ActionManager,\n  NlgManager\n} = require('@nlpjs/nlg');\nconst {\n  SentimentAnalyzer\n} = require('@nlpjs/sentiment');\nconst {\n  SlotManager\n} = require('@nlpjs/slot');\nconst ContextManager = require('./context-manager');\nclass Nlp extends Clonable {\n  constructor(settings = {}, container) {\n    super({\n      settings: {},\n      container: settings.container || container || containerBootstrap()\n    }, container);\n    this.applySettings(this.settings, settings);\n    if (!this.settings.tag) {\n      this.settings.tag = `nlp`;\n    }\n    this.registerDefault();\n    this.applySettings(this.settings, this.container.getConfiguration(this.settings.tag));\n    this.nluManager = this.container.get('nlu-manager', this.settings.nlu);\n    this.ner = this.container.get('ner', this.settings.ner);\n    this.nlgManager = this.container.get('nlg-manager', this.settings.nlg);\n    this.actionManager = this.container.get('action-manager', this.settings.action);\n    this.sentiment = this.container.get('sentiment-analyzer', this.settings.sentiment);\n    this.slotManager = this.container.get('SlotManager', this.settings.slot);\n    this.contextManager = this.container.get('context-manager', this.settings.context);\n    this.forceNER = this.settings.forceNER;\n    if (this.forceNER === undefined) {\n      this.forceNER = false;\n    }\n    this.initialize();\n  }\n  registerDefault() {\n    this.container.registerConfiguration('nlp', {\n      threshold: 0.5,\n      autoLoad: true,\n      autoSave: true,\n      modelFileName: 'model.nlp',\n      executeActionsBeforeAnswers: false\n    }, false);\n    this.use(NluManager);\n    this.use(Ner);\n    this.use(ExtractorEnum);\n    this.use(ExtractorRegex);\n    this.use(ExtractorTrim);\n    this.use(ExtractorBuiltin);\n    this.use(NlgManager);\n    this.use(ActionManager);\n    this.use(NluNeural);\n    this.use(SentimentAnalyzer);\n    this.use(ContextManager);\n    this.container.register('SlotManager', SlotManager, false);\n  }\n  initialize() {\n    if (this.settings.nlu) {\n      const locales = Object.keys(this.settings.nlu);\n      for (let i = 0; i < locales.length; i += 1) {\n        const locale = locales[i];\n        const domains = Object.keys(this.settings.nlu[locale]);\n        for (let j = 0; j < domains.length; j += 1) {\n          const domain = domains[j];\n          const settings = this.settings.nlu[locale][domain];\n          const {\n            className\n          } = settings;\n          delete settings.className;\n          this.useNlu(className, locale, domain, settings);\n        }\n      }\n    }\n    if (this.settings.languages) {\n      this.addLanguage(this.settings.languages);\n    }\n    if (this.settings.locales) {\n      this.addLanguage(this.settings.locales);\n    }\n    if (this.settings.calculateSentiment === undefined) {\n      this.settings.calculateSentiment = true;\n    }\n    if (this.settings.executeActionsBeforeAnswers === undefined) {\n      this.settings.executeActionsBeforeAnswers = false;\n    }\n  }\n  async start() {\n    if (this.settings.corpora) {\n      await this.addCorpora(this.settings.corpora);\n    }\n  }\n  async loadOrTrain() {\n    let loaded = false;\n    if (this.settings.autoLoad) {\n      loaded = await this.load(this.settings.modelFileName);\n    }\n    if (!loaded) {\n      await this.train();\n    }\n  }\n  useNlu(clazz, locale, domain, settings) {\n    if (!locale) {\n      locale = '??';\n    }\n    if (Array.isArray(locale)) {\n      for (let i = 0; i < locale.length; i += 1) {\n        this.useNlu(clazz, locale[i], domain, settings);\n      }\n    } else {\n      const className = typeof clazz === 'string' ? clazz : this.container.use(clazz);\n      let config = this.container.getConfiguration(`domain-manager-${locale}`);\n      if (!config) {\n        config = {};\n        this.container.registerConfiguration(`domain-manager-${locale}`, config);\n      }\n      if (!config.nluByDomain) {\n        config.nluByDomain = {};\n      }\n      const domainName = !domain || domain === '*' ? 'default' : domain;\n      if (!config.nluByDomain[domainName]) {\n        config.nluByDomain[domainName] = {};\n      }\n      config.nluByDomain[domainName].className = className;\n      config.nluByDomain[domainName].settings = settings;\n    }\n  }\n  guessLanguage(input) {\n    return this.nluManager.guessLanguage(input);\n  }\n  addLanguage(locales) {\n    return this.nluManager.addLanguage(locales);\n  }\n  removeLanguage(locales) {\n    return this.nluManager.removeLanguage(locales);\n  }\n  addAdditionalEnumEntityUtterances() {\n    if (!this.settings.languages) {\n      return;\n    }\n    this.settings.languages.forEach(locale => {\n      const replaceTexts = {};\n      const rules = this.ner.getRules(locale);\n      rules.forEach(rule => {\n        if (rule.type === 'enum') {\n          const entityName = this.ner.nameToEntity(rule.name);\n          replaceTexts[entityName] = replaceTexts[entityName] || [];\n          rule.rules.forEach(value => {\n            replaceTexts[entityName] = replaceTexts[entityName].concat(value.texts);\n          });\n        }\n      });\n      const manager = this.nluManager.consolidateManager(locale);\n      const sentences = manager.getSentences();\n      sentences.forEach(sentence => {\n        const entities = this.ner.getEntitiesFromUtterance(locale, sentence.utterance).map(entityName => this.ner.nameToEntity(entityName));\n        this.replaceEnumEntitiesInSentence(manager, locale, sentence.domain, sentence.utterance, sentence.intent, entities, replaceTexts);\n      });\n    });\n  }\n  replaceEnumEntitiesInSentence(manager, locale, domain, utterance, intent, entityList, replaceTexts) {\n    if (!entityList.length) {\n      this.nluManager.guesser.addExtraSentence(locale, utterance);\n      manager.add(domain, utterance, intent);\n      return;\n    }\n    const entityName = entityList[0];\n    if (replaceTexts[entityName] && replaceTexts[entityName].length) {\n      replaceTexts[entityName].forEach(replaceText => {\n        const entityUtterance = utterance.replace(entityName, replaceText);\n        this.replaceEnumEntitiesInSentence(manager, locale, domain, entityUtterance, intent, entityList.slice(1), replaceTexts);\n      });\n    } else {\n      this.replaceEnumEntitiesInSentence(manager, locale, domain, utterance, intent, entityList.slice(1), replaceTexts);\n    }\n  }\n  addDocument(locale, utterance, intent) {\n    const entities = this.ner.getEntitiesFromUtterance(utterance);\n    this.slotManager.addBatch(intent, entities);\n    return this.nluManager.add(locale, utterance, intent);\n  }\n  removeDocument(locale, utterance, intent) {\n    return this.nluManager.remove(locale, utterance, intent);\n  }\n  getRulesByName(locale, name) {\n    return this.ner.getRulesByName(locale, name);\n  }\n  addNerRule(locale, name, type, rule) {\n    return this.ner.addRule(locale, name, type, rule);\n  }\n  removeNerRule(locale, name, rule) {\n    return this.ner.removeRule(locale, name, rule);\n  }\n  addNerRuleOptionTexts(locale, name, option, texts) {\n    return this.ner.addRuleOptionTexts(locale, name, option, texts);\n  }\n  removeNerRuleOptionTexts(locale, name, option, texts) {\n    return this.ner.removeRuleOptionTexts(locale, name, option, texts);\n  }\n  addNerRegexRule(locale, name, regex) {\n    return this.ner.addRegexRule(locale, name, regex);\n  }\n  addNerBetweenCondition(locale, name, left, right, opts) {\n    return this.ner.addBetweenCondition(locale, name, left, right, opts);\n  }\n  addNerBetweenLastCondition(locale, name, left, right, opts) {\n    return this.ner.addBetweenLastCondition(locale, name, left, right, opts);\n  }\n  addNerPositionCondition(locale, name, position, words, opts) {\n    return this.ner.addPositionCondition(locale, name, position, words, opts);\n  }\n  addNerAfterCondition(locale, name, words, opts) {\n    return this.ner.addAfterCondition(locale, name, words, opts);\n  }\n  addNerAfterFirstCondition(locale, name, words, opts) {\n    return this.ner.addAfterFirstCondition(locale, name, words, opts);\n  }\n  addNerAfterLastCondition(locale, name, words, opts) {\n    return this.ner.addAfterLastCondition(locale, name, words, opts);\n  }\n  addNerBeforeCondition(locale, name, words, opts) {\n    return this.ner.addBeforeCondition(locale, name, words, opts);\n  }\n  addNerBeforeFirstCondition(locale, name, words, opts) {\n    return this.ner.addBeforeFirstCondition(locale, name, words, opts);\n  }\n  addNerBeforeLastCondition(locale, name, words, opts) {\n    return this.ner.addBeforeLastCondition(locale, name, words, opts);\n  }\n  assignDomain(locale, intent, domain) {\n    return this.nluManager.assignDomain(locale, intent, domain);\n  }\n  getIntentDomain(locale, intent) {\n    return this.nluManager.getIntentDomain(locale, intent);\n  }\n  getDomains() {\n    return this.nluManager.getDomains();\n  }\n  addAction(intent, action, parameters, fn) {\n    return this.actionManager.addAction(intent, action, parameters, fn);\n  }\n  registerActionFunction(action, fn) {\n    return this.actionManager.registerActionInMap(action, fn);\n  }\n  getActions(intent) {\n    return this.actionManager.findActions(intent);\n  }\n  removeAction(intent, action, parameters) {\n    return this.actionManager.removeAction(intent, action, parameters);\n  }\n  removeActions(intent) {\n    return this.actionManager.removeActions(intent);\n  }\n  removeActionFunction(action) {\n    return this.actionManager.removeActionFromMap(action);\n  }\n  addAnswer(locale, intent, answer, opts) {\n    return this.nlgManager.add(locale, intent, answer, opts);\n  }\n  removeAnswer(locale, intent, answer, opts) {\n    return this.nlgManager.remove(locale, intent, answer, opts);\n  }\n  findAllAnswers(locale, intent) {\n    const response = this.nlgManager.findAllAnswers({\n      locale,\n      intent\n    });\n    return response.answers;\n  }\n  async addCorpora(names) {\n    if (names) {\n      if (Array.isArray(names)) {\n        for (let i = 0; i < names.length; i += 1) {\n          await this.addCorpus(names[i]);\n        }\n      } else {\n        await this.addCorpus(names);\n      }\n    }\n  }\n  async addImported(input) {\n    let content;\n    if (input.content) {\n      content = input.content;\n    } else if (input.filename) {\n      const fs = this.container.get('fs');\n      content = await fs.readFile(input.filename);\n      if (!content) {\n        throw new Error(`Corpus not found \"${input.filename}\"`);\n      }\n    } else {\n      throw new Error('Corpus information without content or file name');\n    }\n    let importer = this.container.get(input.importer);\n    if (!importer) {\n      importer = this.container.get(`${input.importer}-importer`);\n    }\n    if (!importer) {\n      throw new Error(`Corpus importer not found: ${input.importer}`);\n    }\n    const corpora = importer.transform(content, input);\n    for (let i = 0; i < corpora.length; i += 1) {\n      this.addCorpus(corpora[i]);\n    }\n  }\n  addEntities(entities, locale) {\n    const keys = Object.keys(entities);\n    for (let i = 0; i < keys.length; i += 1) {\n      const entityName = keys[i];\n      let entity = entities[entityName];\n      if (typeof entity === 'string') {\n        entity = {\n          regex: [entity]\n        };\n      }\n      let finalLocale = entity.locale;\n      if (!finalLocale) {\n        finalLocale = locale || 'en';\n      }\n      if (typeof finalLocale === 'string') {\n        finalLocale = finalLocale.slice(0, 2);\n      }\n      if (entity.options) {\n        const optionNames = Object.keys(entity.options);\n        for (let j = 0; j < optionNames.length; j += 1) {\n          this.addNerRuleOptionTexts(finalLocale, entityName, optionNames[j], entity.options[optionNames[j]]);\n        }\n      }\n      if (entity.regex) {\n        if (Array.isArray(entity.regex)) {\n          for (let j = 0; j < entity.regex.length; j += 1) {\n            this.addNerRegexRule(finalLocale, entityName, entity.regex[j]);\n          }\n        } else if (typeof entity.regex === 'string' && entity.regex.trim()) {\n          this.addNerRegexRule(finalLocale, entityName, entity.regex);\n        }\n      }\n      if (entity.trim) {\n        for (let j = 0; j < entity.trim.length; j += 1) {\n          switch (entity.trim[j].position) {\n            case 'after':\n            case 'afterLast':\n            case 'afterFirst':\n            case 'before':\n            case 'beforeFirst':\n            case 'beforeLast':\n              this.addNerPositionCondition(finalLocale, entityName, entity.trim[j].position, entity.trim[j].words, entity.trim[j].opts);\n              break;\n            case 'between':\n              this.addNerBetweenCondition(finalLocale, entityName, entity.trim[j].leftWords, entity.trim[j].rightWords, entity.trim[j].opts);\n              break;\n            case 'betweenLast':\n              this.addNerBetweenLastCondition(finalLocale, entityName, entity.trim[j].leftWords, entity.trim[j].rightWords, entity.trim[j].opts);\n              break;\n            default:\n              break;\n          }\n        }\n      }\n    }\n  }\n  addData(data, locale, domain) {\n    for (let i = 0; i < data.length; i += 1) {\n      const current = data[i];\n      const {\n        intent,\n        utterances,\n        answers,\n        slotFilling,\n        actions\n      } = current;\n      for (let j = 0; j < utterances.length; j += 1) {\n        if (domain) {\n          this.assignDomain(locale, intent, domain.name);\n        }\n        this.addDocument(locale, utterances[j], intent);\n      }\n      if (answers) {\n        for (let j = 0; j < answers.length; j += 1) {\n          const answer = answers[j];\n          if (typeof answer === 'string') {\n            this.addAnswer(locale, intent, answer);\n          } else {\n            this.addAnswer(locale, intent, answer.answer, answer.opts);\n          }\n        }\n      }\n      if (slotFilling) {\n        const entities = Object.keys(slotFilling);\n        for (let j = 0; j < entities.length; j += 1) {\n          const slot = slotFilling[entities[j]];\n          let mandatory;\n          const slotQuestions = {};\n          if (typeof slot === 'string') {\n            slotQuestions[locale] = slot;\n            mandatory = true;\n          } else {\n            slotQuestions[locale] = slot.question;\n            mandatory = slot.mandatory || false;\n          }\n          this.slotManager.updateSlot(intent, entities[j], mandatory, slotQuestions);\n        }\n      }\n      if (actions) {\n        actions.forEach(action => {\n          if (!action) return;\n          if (typeof action === 'object') {\n            if (!action.name) return;\n            this.addAction(intent, action.name, action.parameters || []);\n          } else {\n            this.addAction(intent, action, []);\n          }\n        });\n      }\n    }\n  }\n  async addCorpus(fileName) {\n    if (fileName.importer) {\n      await this.addImported(fileName);\n    } else {\n      let corpus = fileName;\n      const fs = this.container.get('fs');\n      if (typeof fileName === 'string') {\n        const fileData = await fs.readFile(fileName);\n        if (!fileData) {\n          throw new Error(`Corpus not found \"${fileName}\"`);\n        }\n        corpus = typeof fileData === 'string' ? JSON.parse(fileData) : fileData;\n      }\n      if (corpus.contextData) {\n        let {\n          contextData\n        } = corpus;\n        if (typeof corpus.contextData === 'string') {\n          contextData = JSON.parse(await fs.readFile(corpus.contextData));\n        }\n        const contextManager = this.container.get('context-manager');\n        const keys = Object.keys(contextData);\n        for (let i = 0; i < keys.length; i += 1) {\n          contextManager.defaultData[keys[i]] = contextData[keys[i]];\n        }\n      }\n      if (corpus.domains) {\n        if (corpus.entities) {\n          this.addEntities(corpus.entities);\n        }\n        for (let i = 0; i < corpus.domains.length; i += 1) {\n          const domain = corpus.domains[i];\n          const {\n            data,\n            entities\n          } = domain;\n          const locale = domain.locale.slice(0, 2);\n          this.addLanguage(locale);\n          if (entities) {\n            this.addEntities(entities, locale);\n          }\n          this.addData(data, locale, domain);\n        }\n      } else {\n        const locale = corpus.locale.slice(0, 2);\n        this.addLanguage(locale);\n        const {\n          data,\n          entities\n        } = corpus;\n        if (entities) {\n          this.addEntities(entities, locale);\n        }\n        this.addData(data, locale);\n      }\n    }\n  }\n  getSentiment(locale, utterance) {\n    if (typeof locale === 'object') {\n      return this.sentiment.process(locale);\n    }\n    if (!utterance) {\n      utterance = locale;\n      locale = this.guessLanguage(utterance);\n    }\n    return this.sentiment.process({\n      utterance,\n      locale\n    });\n  }\n  describeLanguage(locale, name) {\n    this.nluManager.describeLanguage(locale, name);\n  }\n  async train() {\n    this.nluManager.addLanguage(this.settings.languages);\n    const result = await this.nluManager.train();\n    if (this.settings.autoSave) {\n      await this.save(this.settings.modelFileName, true);\n    }\n    return result;\n  }\n  async classify(locale, utterance, settings) {\n    return this.nluManager.process(locale, utterance, settings || this.settings.nlu);\n  }\n  async extractEntities(locale, utterance, context, settings) {\n    if (typeof locale === 'object') {\n      return this.ner.process(locale);\n    }\n    if (!utterance) {\n      utterance = locale;\n      locale = undefined;\n    }\n    if (!locale) {\n      locale = this.guessLanguage(utterance);\n    }\n    const output = await this.ner.process({\n      locale,\n      utterance,\n      context,\n      settings: this.applySettings(settings, this.settings.ner)\n    });\n    return output;\n  }\n  organizeEntities(entities) {\n    const dict = {};\n    for (let i = 0; i < entities.length; i += 1) {\n      const entity = entities[i];\n      if (!dict[entity.entity]) {\n        dict[entity.entity] = [];\n      }\n      dict[entity.entity].push(entity);\n    }\n    const result = [];\n    Object.keys(dict).forEach(key => {\n      const arr = dict[key];\n      if (arr.length === 1) {\n        result.push(arr[0]);\n      } else {\n        for (let i = 0; i < arr.length; i += 1) {\n          arr[i].alias = `${key}_${i}`;\n        }\n        result.push({\n          entity: key,\n          isList: true,\n          items: arr\n        });\n      }\n    });\n    return result;\n  }\n  structureEntities(output) {\n    const organizedEntities = this.organizeEntities(output.entities);\n    if (!output.context.entities) {\n      output.context.entities = {};\n    }\n    for (let i = 0; i < organizedEntities.length; i += 1) {\n      const entity = organizedEntities[i];\n      output.context.entities[entity.entity] = entity;\n      if (entity.alias) {\n        output.context[entity.alias] = entity.sourceText;\n      }\n      if (entity.isList) {\n        for (let j = 0; j < entity.items.length; j += 1) {\n          output.context[entity.items[j].alias] = entity.items[j].sourceText;\n        }\n      } else {\n        // assume that there could be more than one entity with the same name\n        output.context[`${entity.entity}_0`] = entity.sourceText;\n      }\n      output.context[entity.entity] = entity.isList ? entity.items[0].sourceText : entity.sourceText;\n    }\n    return output;\n  }\n  async process(locale, utterance, srcContext, settings) {\n    let sourceInput;\n    let context = srcContext;\n    if (typeof locale === 'object') {\n      if (typeof utterance === 'object' && utterance.value) {\n        locale = undefined;\n        utterance = utterance.value;\n      } else {\n        sourceInput = locale;\n      }\n    }\n    if (!sourceInput) {\n      if (!utterance) {\n        utterance = locale;\n        locale = undefined;\n      }\n      if (!locale) {\n        locale = this.guessLanguage(utterance);\n      }\n      sourceInput = {\n        locale,\n        utterance,\n        settings\n      };\n      if (settings) {\n        if (settings.activity && !sourceInput.activity) {\n          sourceInput.activity = settings.activity;\n        }\n        if (settings.conversationId && !sourceInput.activity) {\n          sourceInput.activity = {\n            conversation: {\n              id: settings.conversationId\n            }\n          };\n        }\n      }\n    } else {\n      locale = sourceInput.locale;\n      utterance = sourceInput.utterance || sourceInput.message || sourceInput.text;\n    }\n    if (!context) {\n      context = await this.contextManager.getContext(sourceInput);\n    }\n    context.channel = sourceInput.channel;\n    context.app = sourceInput.app;\n    context.from = sourceInput.from || null;\n    const input = {\n      locale,\n      utterance,\n      context,\n      settings: this.applySettings(settings, this.settings.nlu)\n    };\n    const forceNER = input.settings && 'forceNER' in input.settings ? input.settings.forceNER : this.forceNER;\n    let output = await this.nluManager.process(input);\n    if (forceNER || !this.slotManager.isEmpty) {\n      const optionalUtterance = await this.ner.generateEntityUtterance(output.locale || locale, utterance);\n      if (optionalUtterance && optionalUtterance !== utterance) {\n        const optionalInput = {\n          locale: output.locale || locale,\n          utterance: optionalUtterance,\n          context,\n          settings: this.applySettings(settings, this.settings.nlu)\n        };\n        const optionalOutput = await this.nluManager.process(optionalInput);\n        if (optionalOutput && (optionalOutput.score > output.score || output.intent === 'None')) {\n          output = optionalOutput;\n          output.utterance = utterance;\n          output.optionalUtterance = optionalUtterance;\n        }\n      }\n    }\n    if (output.score < this.settings.threshold) {\n      output.score = 1;\n      output.intent = 'None';\n    }\n    output.context = context;\n    if (forceNER || !this.slotManager.isEmpty) {\n      const intentEntities = this.slotManager.getIntentEntityNames(output.intent);\n      output = await this.ner.process({\n        ...output\n      }, intentEntities);\n    } else {\n      output.entities = [];\n      output.sourceEntities = [];\n    }\n    const stemmer = this.container.get(`stemmer-${output.locale}`);\n    if (stemmer && stemmer.lastFill) {\n      stemmer.lastFill(output);\n    }\n    output = this.structureEntities(output);\n    if (forceNER || !this.slotManager.isEmpty) {\n      if (this.slotManager.process(output, context)) {\n        // structure entities again because slots may have added\n        output = this.structureEntities(output);\n      }\n      context.slotFill = output.slotFill;\n    }\n    if (this.settings.executeActionsBeforeAnswers) {\n      output = await this.actionManager.run({\n        ...output\n      });\n    }\n    if (this.settings.executeActionsBeforeAnswers && output.answer) {\n      // Render answer from actions and use as final answer\n      output.answer = this.nlgManager.renderText(output.answer, context);\n    } else {\n      const answers = await this.nlgManager.run({\n        ...output\n      });\n      output.answers = answers.answers;\n      output.answer = answers.answer;\n    }\n    if (output.srcAnswer) {\n      // Re-Render Answer to also replace newly added entities in srcAnswer\n      output.answer = this.nlgManager.renderText(output.srcAnswer, context);\n    }\n    if (!this.settings.executeActionsBeforeAnswers) {\n      output = await this.actionManager.run({\n        ...output\n      });\n    }\n    if (this.settings.calculateSentiment) {\n      const sentiment = await this.getSentiment(locale, utterance);\n      output.sentiment = sentiment ? sentiment.sentiment : undefined;\n    }\n    await this.contextManager.setContext(sourceInput, context);\n    delete output.context;\n    delete output.settings;\n    const result = sourceInput ? this.applySettings(sourceInput, output) : output;\n    if (result.intent === 'None' && !result.answer) {\n      const openQuestion = this.container.get('open-question');\n      if (openQuestion) {\n        const qnaAnswer = await openQuestion.getAnswer(result.locale, result.utterance);\n        if (qnaAnswer && qnaAnswer.answer && qnaAnswer.answer.length > 0) {\n          result.answer = qnaAnswer.answer;\n          result.isOpenQuestionAnswer = true;\n          result.openQuestionFirstCharacter = qnaAnswer.position;\n          result.openQuestionScore = qnaAnswer.score;\n        }\n      }\n    }\n    if (this.onIntent) {\n      await this.onIntent(this, result);\n    } else {\n      const eventName = `onIntent(${result.intent})`;\n      const pipeline = this.container.getPipeline(eventName);\n      if (pipeline) {\n        await this.container.runPipeline(pipeline, result, this);\n      }\n    }\n    return result;\n  }\n  toJSON() {\n    const result = {\n      settings: {\n        ...this.settings\n      },\n      nluManager: this.nluManager.toJSON(),\n      ner: this.ner.toJSON(),\n      nlgManager: this.nlgManager.toJSON(),\n      actionManager: this.actionManager.toJSON(),\n      slotManager: this.slotManager.save()\n    };\n    delete result.settings.container;\n    return result;\n  }\n  fromJSON(json) {\n    this.applySettings(this.settings, json.settings);\n    this.nluManager.fromJSON(json.nluManager);\n    this.ner.fromJSON(json.ner);\n    this.nlgManager.fromJSON(json.nlgManager);\n    this.actionManager.fromJSON(json.actionManager);\n    this.slotManager.load(json.slotManager);\n  }\n  export(minified = false) {\n    const clone = this.toJSON();\n    return minified ? JSON.stringify(clone) : JSON.stringify(clone, null, 2);\n  }\n  import(data) {\n    const clone = typeof data === 'string' ? JSON.parse(data) : data;\n    this.fromJSON(clone);\n  }\n  async save(srcFileName, minified = false) {\n    const fs = this.container.get('fs');\n    const fileName = srcFileName || 'model.nlp';\n    await fs.writeFile(fileName, this.export(minified));\n  }\n  async load(srcFileName) {\n    const fs = this.container.get('fs');\n    const fileName = srcFileName || 'model.nlp';\n    const data = await fs.readFile(fileName);\n    if (data) {\n      this.import(data);\n      return true;\n    }\n    return false;\n  }\n}\nmodule.exports = Nlp;","map":{"version":3,"names":["Clonable","containerBootstrap","require","NluManager","NluNeural","Ner","ExtractorEnum","ExtractorRegex","ExtractorTrim","ExtractorBuiltin","ActionManager","NlgManager","SentimentAnalyzer","SlotManager","ContextManager","Nlp","constructor","settings","container","applySettings","tag","registerDefault","getConfiguration","nluManager","get","nlu","ner","nlgManager","nlg","actionManager","action","sentiment","slotManager","slot","contextManager","context","forceNER","undefined","initialize","registerConfiguration","threshold","autoLoad","autoSave","modelFileName","executeActionsBeforeAnswers","use","register","locales","Object","keys","i","length","locale","domains","j","domain","className","useNlu","languages","addLanguage","calculateSentiment","start","corpora","addCorpora","loadOrTrain","loaded","load","train","clazz","Array","isArray","config","nluByDomain","domainName","guessLanguage","input","removeLanguage","addAdditionalEnumEntityUtterances","forEach","replaceTexts","rules","getRules","rule","type","entityName","nameToEntity","name","value","concat","texts","manager","consolidateManager","sentences","getSentences","sentence","entities","getEntitiesFromUtterance","utterance","map","replaceEnumEntitiesInSentence","intent","entityList","guesser","addExtraSentence","add","replaceText","entityUtterance","replace","slice","addDocument","addBatch","removeDocument","remove","getRulesByName","addNerRule","addRule","removeNerRule","removeRule","addNerRuleOptionTexts","option","addRuleOptionTexts","removeNerRuleOptionTexts","removeRuleOptionTexts","addNerRegexRule","regex","addRegexRule","addNerBetweenCondition","left","right","opts","addBetweenCondition","addNerBetweenLastCondition","addBetweenLastCondition","addNerPositionCondition","position","words","addPositionCondition","addNerAfterCondition","addAfterCondition","addNerAfterFirstCondition","addAfterFirstCondition","addNerAfterLastCondition","addAfterLastCondition","addNerBeforeCondition","addBeforeCondition","addNerBeforeFirstCondition","addBeforeFirstCondition","addNerBeforeLastCondition","addBeforeLastCondition","assignDomain","getIntentDomain","getDomains","addAction","parameters","fn","registerActionFunction","registerActionInMap","getActions","findActions","removeAction","removeActions","removeActionFunction","removeActionFromMap","addAnswer","answer","removeAnswer","findAllAnswers","response","answers","names","addCorpus","addImported","content","filename","fs","readFile","Error","importer","transform","addEntities","entity","finalLocale","options","optionNames","trim","leftWords","rightWords","addData","data","current","utterances","slotFilling","actions","mandatory","slotQuestions","question","updateSlot","fileName","corpus","fileData","JSON","parse","contextData","defaultData","getSentiment","process","describeLanguage","result","save","classify","extractEntities","output","organizeEntities","dict","push","key","arr","alias","isList","items","structureEntities","organizedEntities","sourceText","srcContext","sourceInput","activity","conversationId","conversation","id","message","text","getContext","channel","app","from","isEmpty","optionalUtterance","generateEntityUtterance","optionalInput","optionalOutput","score","intentEntities","getIntentEntityNames","sourceEntities","stemmer","lastFill","slotFill","run","renderText","srcAnswer","setContext","openQuestion","qnaAnswer","getAnswer","isOpenQuestionAnswer","openQuestionFirstCharacter","openQuestionScore","onIntent","eventName","pipeline","getPipeline","runPipeline","toJSON","fromJSON","json","export","minified","clone","stringify","import","srcFileName","writeFile","module","exports"],"sources":["/Users/zyq/Desktop/大二下/暑期实习/moonshot project/node_modules/@nlpjs/nlp/src/nlp.js"],"sourcesContent":["/*\n * Copyright (c) AXA Group Operations Spain S.A.\n *\n * Permission is hereby granted, free of charge, to any person obtaining\n * a copy of this software and associated documentation files (the\n * \"Software\"), to deal in the Software without restriction, including\n * without limitation the rights to use, copy, modify, merge, publish,\n * distribute, sublicense, and/or sell copies of the Software, and to\n * permit persons to whom the Software is furnished to do so, subject to\n * the following conditions:\n *\n * The above copyright notice and this permission notice shall be\n * included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\n * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\n * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\nconst { Clonable, containerBootstrap } = require('@nlpjs/core');\nconst { NluManager, NluNeural } = require('@nlpjs/nlu');\nconst {\n  Ner,\n  ExtractorEnum,\n  ExtractorRegex,\n  ExtractorTrim,\n  ExtractorBuiltin,\n} = require('@nlpjs/ner');\nconst { ActionManager, NlgManager } = require('@nlpjs/nlg');\nconst { SentimentAnalyzer } = require('@nlpjs/sentiment');\nconst { SlotManager } = require('@nlpjs/slot');\nconst ContextManager = require('./context-manager');\n\nclass Nlp extends Clonable {\n  constructor(settings = {}, container) {\n    super(\n      {\n        settings: {},\n        container: settings.container || container || containerBootstrap(),\n      },\n      container\n    );\n    this.applySettings(this.settings, settings);\n    if (!this.settings.tag) {\n      this.settings.tag = `nlp`;\n    }\n    this.registerDefault();\n    this.applySettings(\n      this.settings,\n      this.container.getConfiguration(this.settings.tag)\n    );\n    this.nluManager = this.container.get('nlu-manager', this.settings.nlu);\n    this.ner = this.container.get('ner', this.settings.ner);\n    this.nlgManager = this.container.get('nlg-manager', this.settings.nlg);\n    this.actionManager = this.container.get(\n      'action-manager',\n      this.settings.action\n    );\n    this.sentiment = this.container.get(\n      'sentiment-analyzer',\n      this.settings.sentiment\n    );\n    this.slotManager = this.container.get('SlotManager', this.settings.slot);\n    this.contextManager = this.container.get(\n      'context-manager',\n      this.settings.context\n    );\n    this.forceNER = this.settings.forceNER;\n    if (this.forceNER === undefined) {\n      this.forceNER = false;\n    }\n    this.initialize();\n  }\n\n  registerDefault() {\n    this.container.registerConfiguration(\n      'nlp',\n      {\n        threshold: 0.5,\n        autoLoad: true,\n        autoSave: true,\n        modelFileName: 'model.nlp',\n        executeActionsBeforeAnswers: false,\n      },\n      false\n    );\n    this.use(NluManager);\n    this.use(Ner);\n    this.use(ExtractorEnum);\n    this.use(ExtractorRegex);\n    this.use(ExtractorTrim);\n    this.use(ExtractorBuiltin);\n    this.use(NlgManager);\n    this.use(ActionManager);\n    this.use(NluNeural);\n    this.use(SentimentAnalyzer);\n    this.use(ContextManager);\n    this.container.register('SlotManager', SlotManager, false);\n  }\n\n  initialize() {\n    if (this.settings.nlu) {\n      const locales = Object.keys(this.settings.nlu);\n      for (let i = 0; i < locales.length; i += 1) {\n        const locale = locales[i];\n        const domains = Object.keys(this.settings.nlu[locale]);\n        for (let j = 0; j < domains.length; j += 1) {\n          const domain = domains[j];\n          const settings = this.settings.nlu[locale][domain];\n          const { className } = settings;\n          delete settings.className;\n          this.useNlu(className, locale, domain, settings);\n        }\n      }\n    }\n    if (this.settings.languages) {\n      this.addLanguage(this.settings.languages);\n    }\n    if (this.settings.locales) {\n      this.addLanguage(this.settings.locales);\n    }\n    if (this.settings.calculateSentiment === undefined) {\n      this.settings.calculateSentiment = true;\n    }\n    if (this.settings.executeActionsBeforeAnswers === undefined) {\n      this.settings.executeActionsBeforeAnswers = false;\n    }\n  }\n\n  async start() {\n    if (this.settings.corpora) {\n      await this.addCorpora(this.settings.corpora);\n    }\n  }\n\n  async loadOrTrain() {\n    let loaded = false;\n    if (this.settings.autoLoad) {\n      loaded = await this.load(this.settings.modelFileName);\n    }\n    if (!loaded) {\n      await this.train();\n    }\n  }\n\n  useNlu(clazz, locale, domain, settings) {\n    if (!locale) {\n      locale = '??';\n    }\n    if (Array.isArray(locale)) {\n      for (let i = 0; i < locale.length; i += 1) {\n        this.useNlu(clazz, locale[i], domain, settings);\n      }\n    } else {\n      const className =\n        typeof clazz === 'string' ? clazz : this.container.use(clazz);\n      let config = this.container.getConfiguration(`domain-manager-${locale}`);\n      if (!config) {\n        config = {};\n        this.container.registerConfiguration(\n          `domain-manager-${locale}`,\n          config\n        );\n      }\n      if (!config.nluByDomain) {\n        config.nluByDomain = {};\n      }\n      const domainName = !domain || domain === '*' ? 'default' : domain;\n      if (!config.nluByDomain[domainName]) {\n        config.nluByDomain[domainName] = {};\n      }\n      config.nluByDomain[domainName].className = className;\n      config.nluByDomain[domainName].settings = settings;\n    }\n  }\n\n  guessLanguage(input) {\n    return this.nluManager.guessLanguage(input);\n  }\n\n  addLanguage(locales) {\n    return this.nluManager.addLanguage(locales);\n  }\n\n  removeLanguage(locales) {\n    return this.nluManager.removeLanguage(locales);\n  }\n\n  addAdditionalEnumEntityUtterances() {\n    if (!this.settings.languages) {\n      return;\n    }\n    this.settings.languages.forEach((locale) => {\n      const replaceTexts = {};\n      const rules = this.ner.getRules(locale);\n      rules.forEach((rule) => {\n        if (rule.type === 'enum') {\n          const entityName = this.ner.nameToEntity(rule.name);\n          replaceTexts[entityName] = replaceTexts[entityName] || [];\n          rule.rules.forEach((value) => {\n            replaceTexts[entityName] = replaceTexts[entityName].concat(\n              value.texts\n            );\n          });\n        }\n      });\n      const manager = this.nluManager.consolidateManager(locale);\n      const sentences = manager.getSentences();\n      sentences.forEach((sentence) => {\n        const entities = this.ner\n          .getEntitiesFromUtterance(locale, sentence.utterance)\n          .map((entityName) => this.ner.nameToEntity(entityName));\n        this.replaceEnumEntitiesInSentence(\n          manager,\n          locale,\n          sentence.domain,\n          sentence.utterance,\n          sentence.intent,\n          entities,\n          replaceTexts\n        );\n      });\n    });\n  }\n\n  replaceEnumEntitiesInSentence(\n    manager,\n    locale,\n    domain,\n    utterance,\n    intent,\n    entityList,\n    replaceTexts\n  ) {\n    if (!entityList.length) {\n      this.nluManager.guesser.addExtraSentence(locale, utterance);\n      manager.add(domain, utterance, intent);\n      return;\n    }\n    const entityName = entityList[0];\n    if (replaceTexts[entityName] && replaceTexts[entityName].length) {\n      replaceTexts[entityName].forEach((replaceText) => {\n        const entityUtterance = utterance.replace(entityName, replaceText);\n        this.replaceEnumEntitiesInSentence(\n          manager,\n          locale,\n          domain,\n          entityUtterance,\n          intent,\n          entityList.slice(1),\n          replaceTexts\n        );\n      });\n    } else {\n      this.replaceEnumEntitiesInSentence(\n        manager,\n        locale,\n        domain,\n        utterance,\n        intent,\n        entityList.slice(1),\n        replaceTexts\n      );\n    }\n  }\n\n  addDocument(locale, utterance, intent) {\n    const entities = this.ner.getEntitiesFromUtterance(utterance);\n    this.slotManager.addBatch(intent, entities);\n    return this.nluManager.add(locale, utterance, intent);\n  }\n\n  removeDocument(locale, utterance, intent) {\n    return this.nluManager.remove(locale, utterance, intent);\n  }\n\n  getRulesByName(locale, name) {\n    return this.ner.getRulesByName(locale, name);\n  }\n\n  addNerRule(locale, name, type, rule) {\n    return this.ner.addRule(locale, name, type, rule);\n  }\n\n  removeNerRule(locale, name, rule) {\n    return this.ner.removeRule(locale, name, rule);\n  }\n\n  addNerRuleOptionTexts(locale, name, option, texts) {\n    return this.ner.addRuleOptionTexts(locale, name, option, texts);\n  }\n\n  removeNerRuleOptionTexts(locale, name, option, texts) {\n    return this.ner.removeRuleOptionTexts(locale, name, option, texts);\n  }\n\n  addNerRegexRule(locale, name, regex) {\n    return this.ner.addRegexRule(locale, name, regex);\n  }\n\n  addNerBetweenCondition(locale, name, left, right, opts) {\n    return this.ner.addBetweenCondition(locale, name, left, right, opts);\n  }\n\n  addNerBetweenLastCondition(locale, name, left, right, opts) {\n    return this.ner.addBetweenLastCondition(locale, name, left, right, opts);\n  }\n\n  addNerPositionCondition(locale, name, position, words, opts) {\n    return this.ner.addPositionCondition(locale, name, position, words, opts);\n  }\n\n  addNerAfterCondition(locale, name, words, opts) {\n    return this.ner.addAfterCondition(locale, name, words, opts);\n  }\n\n  addNerAfterFirstCondition(locale, name, words, opts) {\n    return this.ner.addAfterFirstCondition(locale, name, words, opts);\n  }\n\n  addNerAfterLastCondition(locale, name, words, opts) {\n    return this.ner.addAfterLastCondition(locale, name, words, opts);\n  }\n\n  addNerBeforeCondition(locale, name, words, opts) {\n    return this.ner.addBeforeCondition(locale, name, words, opts);\n  }\n\n  addNerBeforeFirstCondition(locale, name, words, opts) {\n    return this.ner.addBeforeFirstCondition(locale, name, words, opts);\n  }\n\n  addNerBeforeLastCondition(locale, name, words, opts) {\n    return this.ner.addBeforeLastCondition(locale, name, words, opts);\n  }\n\n  assignDomain(locale, intent, domain) {\n    return this.nluManager.assignDomain(locale, intent, domain);\n  }\n\n  getIntentDomain(locale, intent) {\n    return this.nluManager.getIntentDomain(locale, intent);\n  }\n\n  getDomains() {\n    return this.nluManager.getDomains();\n  }\n\n  addAction(intent, action, parameters, fn) {\n    return this.actionManager.addAction(intent, action, parameters, fn);\n  }\n\n  registerActionFunction(action, fn) {\n    return this.actionManager.registerActionInMap(action, fn);\n  }\n\n  getActions(intent) {\n    return this.actionManager.findActions(intent);\n  }\n\n  removeAction(intent, action, parameters) {\n    return this.actionManager.removeAction(intent, action, parameters);\n  }\n\n  removeActions(intent) {\n    return this.actionManager.removeActions(intent);\n  }\n\n  removeActionFunction(action) {\n    return this.actionManager.removeActionFromMap(action);\n  }\n\n  addAnswer(locale, intent, answer, opts) {\n    return this.nlgManager.add(locale, intent, answer, opts);\n  }\n\n  removeAnswer(locale, intent, answer, opts) {\n    return this.nlgManager.remove(locale, intent, answer, opts);\n  }\n\n  findAllAnswers(locale, intent) {\n    const response = this.nlgManager.findAllAnswers({ locale, intent });\n    return response.answers;\n  }\n\n  async addCorpora(names) {\n    if (names) {\n      if (Array.isArray(names)) {\n        for (let i = 0; i < names.length; i += 1) {\n          await this.addCorpus(names[i]);\n        }\n      } else {\n        await this.addCorpus(names);\n      }\n    }\n  }\n\n  async addImported(input) {\n    let content;\n    if (input.content) {\n      content = input.content;\n    } else if (input.filename) {\n      const fs = this.container.get('fs');\n      content = await fs.readFile(input.filename);\n      if (!content) {\n        throw new Error(`Corpus not found \"${input.filename}\"`);\n      }\n    } else {\n      throw new Error('Corpus information without content or file name');\n    }\n    let importer = this.container.get(input.importer);\n    if (!importer) {\n      importer = this.container.get(`${input.importer}-importer`);\n    }\n    if (!importer) {\n      throw new Error(`Corpus importer not found: ${input.importer}`);\n    }\n    const corpora = importer.transform(content, input);\n    for (let i = 0; i < corpora.length; i += 1) {\n      this.addCorpus(corpora[i]);\n    }\n  }\n\n  addEntities(entities, locale) {\n    const keys = Object.keys(entities);\n    for (let i = 0; i < keys.length; i += 1) {\n      const entityName = keys[i];\n      let entity = entities[entityName];\n      if (typeof entity === 'string') {\n        entity = { regex: [entity] };\n      }\n      let finalLocale = entity.locale;\n      if (!finalLocale) {\n        finalLocale = locale || 'en';\n      }\n      if (typeof finalLocale === 'string') {\n        finalLocale = finalLocale.slice(0, 2);\n      }\n      if (entity.options) {\n        const optionNames = Object.keys(entity.options);\n        for (let j = 0; j < optionNames.length; j += 1) {\n          this.addNerRuleOptionTexts(\n            finalLocale,\n            entityName,\n            optionNames[j],\n            entity.options[optionNames[j]]\n          );\n        }\n      }\n      if (entity.regex) {\n        if (Array.isArray(entity.regex)) {\n          for (let j = 0; j < entity.regex.length; j += 1) {\n            this.addNerRegexRule(finalLocale, entityName, entity.regex[j]);\n          }\n        } else if (typeof entity.regex === 'string' && entity.regex.trim()) {\n          this.addNerRegexRule(finalLocale, entityName, entity.regex);\n        }\n      }\n      if (entity.trim) {\n        for (let j = 0; j < entity.trim.length; j += 1) {\n          switch (entity.trim[j].position) {\n            case 'after':\n            case 'afterLast':\n            case 'afterFirst':\n            case 'before':\n            case 'beforeFirst':\n            case 'beforeLast':\n              this.addNerPositionCondition(\n                finalLocale,\n                entityName,\n                entity.trim[j].position,\n                entity.trim[j].words,\n                entity.trim[j].opts\n              );\n              break;\n            case 'between':\n              this.addNerBetweenCondition(\n                finalLocale,\n                entityName,\n                entity.trim[j].leftWords,\n                entity.trim[j].rightWords,\n                entity.trim[j].opts\n              );\n              break;\n            case 'betweenLast':\n              this.addNerBetweenLastCondition(\n                finalLocale,\n                entityName,\n                entity.trim[j].leftWords,\n                entity.trim[j].rightWords,\n                entity.trim[j].opts\n              );\n              break;\n            default:\n              break;\n          }\n        }\n      }\n    }\n  }\n\n  addData(data, locale, domain) {\n    for (let i = 0; i < data.length; i += 1) {\n      const current = data[i];\n      const { intent, utterances, answers, slotFilling, actions } = current;\n      for (let j = 0; j < utterances.length; j += 1) {\n        if (domain) {\n          this.assignDomain(locale, intent, domain.name);\n        }\n        this.addDocument(locale, utterances[j], intent);\n      }\n      if (answers) {\n        for (let j = 0; j < answers.length; j += 1) {\n          const answer = answers[j];\n          if (typeof answer === 'string') {\n            this.addAnswer(locale, intent, answer);\n          } else {\n            this.addAnswer(locale, intent, answer.answer, answer.opts);\n          }\n        }\n      }\n      if (slotFilling) {\n        const entities = Object.keys(slotFilling);\n        for (let j = 0; j < entities.length; j += 1) {\n          const slot = slotFilling[entities[j]];\n          let mandatory;\n          const slotQuestions = {};\n          if (typeof slot === 'string') {\n            slotQuestions[locale] = slot;\n            mandatory = true;\n          } else {\n            slotQuestions[locale] = slot.question;\n            mandatory = slot.mandatory || false;\n          }\n          this.slotManager.updateSlot(\n            intent,\n            entities[j],\n            mandatory,\n            slotQuestions\n          );\n        }\n      }\n      if (actions) {\n        actions.forEach((action) => {\n          if (!action) return;\n          if (typeof action === 'object') {\n            if (!action.name) return;\n            this.addAction(intent, action.name, action.parameters || []);\n          } else {\n            this.addAction(intent, action, []);\n          }\n        });\n      }\n    }\n  }\n\n  async addCorpus(fileName) {\n    if (fileName.importer) {\n      await this.addImported(fileName);\n    } else {\n      let corpus = fileName;\n      const fs = this.container.get('fs');\n      if (typeof fileName === 'string') {\n        const fileData = await fs.readFile(fileName);\n        if (!fileData) {\n          throw new Error(`Corpus not found \"${fileName}\"`);\n        }\n        corpus = typeof fileData === 'string' ? JSON.parse(fileData) : fileData;\n      }\n      if (corpus.contextData) {\n        let { contextData } = corpus;\n        if (typeof corpus.contextData === 'string') {\n          contextData = JSON.parse(await fs.readFile(corpus.contextData));\n        }\n        const contextManager = this.container.get('context-manager');\n        const keys = Object.keys(contextData);\n        for (let i = 0; i < keys.length; i += 1) {\n          contextManager.defaultData[keys[i]] = contextData[keys[i]];\n        }\n      }\n      if (corpus.domains) {\n        if (corpus.entities) {\n          this.addEntities(corpus.entities);\n        }\n        for (let i = 0; i < corpus.domains.length; i += 1) {\n          const domain = corpus.domains[i];\n          const { data, entities } = domain;\n          const locale = domain.locale.slice(0, 2);\n          this.addLanguage(locale);\n          if (entities) {\n            this.addEntities(entities, locale);\n          }\n          this.addData(data, locale, domain);\n        }\n      } else {\n        const locale = corpus.locale.slice(0, 2);\n        this.addLanguage(locale);\n        const { data, entities } = corpus;\n        if (entities) {\n          this.addEntities(entities, locale);\n        }\n        this.addData(data, locale);\n      }\n    }\n  }\n\n  getSentiment(locale, utterance) {\n    if (typeof locale === 'object') {\n      return this.sentiment.process(locale);\n    }\n    if (!utterance) {\n      utterance = locale;\n      locale = this.guessLanguage(utterance);\n    }\n    return this.sentiment.process({ utterance, locale });\n  }\n\n  describeLanguage(locale, name) {\n    this.nluManager.describeLanguage(locale, name);\n  }\n\n  async train() {\n    this.nluManager.addLanguage(this.settings.languages);\n    const result = await this.nluManager.train();\n    if (this.settings.autoSave) {\n      await this.save(this.settings.modelFileName, true);\n    }\n    return result;\n  }\n\n  async classify(locale, utterance, settings) {\n    return this.nluManager.process(\n      locale,\n      utterance,\n      settings || this.settings.nlu\n    );\n  }\n\n  async extractEntities(locale, utterance, context, settings) {\n    if (typeof locale === 'object') {\n      return this.ner.process(locale);\n    }\n    if (!utterance) {\n      utterance = locale;\n      locale = undefined;\n    }\n    if (!locale) {\n      locale = this.guessLanguage(utterance);\n    }\n    const output = await this.ner.process({\n      locale,\n      utterance,\n      context,\n      settings: this.applySettings(settings, this.settings.ner),\n    });\n    return output;\n  }\n\n  organizeEntities(entities) {\n    const dict = {};\n    for (let i = 0; i < entities.length; i += 1) {\n      const entity = entities[i];\n      if (!dict[entity.entity]) {\n        dict[entity.entity] = [];\n      }\n      dict[entity.entity].push(entity);\n    }\n    const result = [];\n    Object.keys(dict).forEach((key) => {\n      const arr = dict[key];\n      if (arr.length === 1) {\n        result.push(arr[0]);\n      } else {\n        for (let i = 0; i < arr.length; i += 1) {\n          arr[i].alias = `${key}_${i}`;\n        }\n        result.push({\n          entity: key,\n          isList: true,\n          items: arr,\n        });\n      }\n    });\n    return result;\n  }\n\n  structureEntities(output) {\n    const organizedEntities = this.organizeEntities(output.entities);\n    if (!output.context.entities) {\n      output.context.entities = {};\n    }\n    for (let i = 0; i < organizedEntities.length; i += 1) {\n      const entity = organizedEntities[i];\n      output.context.entities[entity.entity] = entity;\n      if (entity.alias) {\n        output.context[entity.alias] = entity.sourceText;\n      }\n      if (entity.isList) {\n        for (let j = 0; j < entity.items.length; j += 1) {\n          output.context[entity.items[j].alias] = entity.items[j].sourceText;\n        }\n      } else {\n        // assume that there could be more than one entity with the same name\n        output.context[`${entity.entity}_0`] = entity.sourceText;\n      }\n      output.context[entity.entity] = entity.isList\n        ? entity.items[0].sourceText\n        : entity.sourceText;\n    }\n    return output;\n  }\n\n  async process(locale, utterance, srcContext, settings) {\n    let sourceInput;\n    let context = srcContext;\n    if (typeof locale === 'object') {\n      if (typeof utterance === 'object' && utterance.value) {\n        locale = undefined;\n        utterance = utterance.value;\n      } else {\n        sourceInput = locale;\n      }\n    }\n    if (!sourceInput) {\n      if (!utterance) {\n        utterance = locale;\n        locale = undefined;\n      }\n      if (!locale) {\n        locale = this.guessLanguage(utterance);\n      }\n      sourceInput = {\n        locale,\n        utterance,\n        settings,\n      };\n      if (settings) {\n        if (settings.activity && !sourceInput.activity) {\n          sourceInput.activity = settings.activity;\n        }\n        if (settings.conversationId && !sourceInput.activity) {\n          sourceInput.activity = {\n            conversation: {\n              id: settings.conversationId,\n            },\n          };\n        }\n      }\n    } else {\n      locale = sourceInput.locale;\n      utterance =\n        sourceInput.utterance || sourceInput.message || sourceInput.text;\n    }\n    if (!context) {\n      context = await this.contextManager.getContext(sourceInput);\n    }\n    context.channel = sourceInput.channel;\n    context.app = sourceInput.app;\n    context.from = sourceInput.from || null;\n    const input = {\n      locale,\n      utterance,\n      context,\n      settings: this.applySettings(settings, this.settings.nlu),\n    };\n    const forceNER =\n      input.settings && 'forceNER' in input.settings\n        ? input.settings.forceNER\n        : this.forceNER;\n    let output = await this.nluManager.process(input);\n    if (forceNER || !this.slotManager.isEmpty) {\n      const optionalUtterance = await this.ner.generateEntityUtterance(\n        output.locale || locale,\n        utterance\n      );\n      if (optionalUtterance && optionalUtterance !== utterance) {\n        const optionalInput = {\n          locale: output.locale || locale,\n          utterance: optionalUtterance,\n          context,\n          settings: this.applySettings(settings, this.settings.nlu),\n        };\n        const optionalOutput = await this.nluManager.process(optionalInput);\n        if (\n          optionalOutput &&\n          (optionalOutput.score > output.score || output.intent === 'None')\n        ) {\n          output = optionalOutput;\n          output.utterance = utterance;\n          output.optionalUtterance = optionalUtterance;\n        }\n      }\n    }\n    if (output.score < this.settings.threshold) {\n      output.score = 1;\n      output.intent = 'None';\n    }\n    output.context = context;\n    if (forceNER || !this.slotManager.isEmpty) {\n      const intentEntities = this.slotManager.getIntentEntityNames(\n        output.intent\n      );\n      output = await this.ner.process({ ...output }, intentEntities);\n    } else {\n      output.entities = [];\n      output.sourceEntities = [];\n    }\n    const stemmer = this.container.get(`stemmer-${output.locale}`);\n    if (stemmer && stemmer.lastFill) {\n      stemmer.lastFill(output);\n    }\n    output = this.structureEntities(output);\n    if (forceNER || !this.slotManager.isEmpty) {\n      if (this.slotManager.process(output, context)) {\n        // structure entities again because slots may have added\n        output = this.structureEntities(output);\n      }\n      context.slotFill = output.slotFill;\n    }\n    if (this.settings.executeActionsBeforeAnswers) {\n      output = await this.actionManager.run({ ...output });\n    }\n    if (this.settings.executeActionsBeforeAnswers && output.answer) {\n      // Render answer from actions and use as final answer\n      output.answer = this.nlgManager.renderText(output.answer, context);\n    } else {\n      const answers = await this.nlgManager.run({ ...output });\n      output.answers = answers.answers;\n      output.answer = answers.answer;\n    }\n    if (output.srcAnswer) {\n      // Re-Render Answer to also replace newly added entities in srcAnswer\n      output.answer = this.nlgManager.renderText(output.srcAnswer, context);\n    }\n    if (!this.settings.executeActionsBeforeAnswers) {\n      output = await this.actionManager.run({ ...output });\n    }\n    if (this.settings.calculateSentiment) {\n      const sentiment = await this.getSentiment(locale, utterance);\n      output.sentiment = sentiment ? sentiment.sentiment : undefined;\n    }\n    await this.contextManager.setContext(sourceInput, context);\n    delete output.context;\n    delete output.settings;\n    const result = sourceInput\n      ? this.applySettings(sourceInput, output)\n      : output;\n    if (result.intent === 'None' && !result.answer) {\n      const openQuestion = this.container.get('open-question');\n      if (openQuestion) {\n        const qnaAnswer = await openQuestion.getAnswer(\n          result.locale,\n          result.utterance\n        );\n        if (qnaAnswer && qnaAnswer.answer && qnaAnswer.answer.length > 0) {\n          result.answer = qnaAnswer.answer;\n          result.isOpenQuestionAnswer = true;\n          result.openQuestionFirstCharacter = qnaAnswer.position;\n          result.openQuestionScore = qnaAnswer.score;\n        }\n      }\n    }\n    if (this.onIntent) {\n      await this.onIntent(this, result);\n    } else {\n      const eventName = `onIntent(${result.intent})`;\n      const pipeline = this.container.getPipeline(eventName);\n      if (pipeline) {\n        await this.container.runPipeline(pipeline, result, this);\n      }\n    }\n    return result;\n  }\n\n  toJSON() {\n    const result = {\n      settings: { ...this.settings },\n      nluManager: this.nluManager.toJSON(),\n      ner: this.ner.toJSON(),\n      nlgManager: this.nlgManager.toJSON(),\n      actionManager: this.actionManager.toJSON(),\n      slotManager: this.slotManager.save(),\n    };\n    delete result.settings.container;\n\n    return result;\n  }\n\n  fromJSON(json) {\n    this.applySettings(this.settings, json.settings);\n    this.nluManager.fromJSON(json.nluManager);\n    this.ner.fromJSON(json.ner);\n    this.nlgManager.fromJSON(json.nlgManager);\n    this.actionManager.fromJSON(json.actionManager);\n    this.slotManager.load(json.slotManager);\n  }\n\n  export(minified = false) {\n    const clone = this.toJSON();\n    return minified ? JSON.stringify(clone) : JSON.stringify(clone, null, 2);\n  }\n\n  import(data) {\n    const clone = typeof data === 'string' ? JSON.parse(data) : data;\n    this.fromJSON(clone);\n  }\n\n  async save(srcFileName, minified = false) {\n    const fs = this.container.get('fs');\n    const fileName = srcFileName || 'model.nlp';\n    await fs.writeFile(fileName, this.export(minified));\n  }\n\n  async load(srcFileName) {\n    const fs = this.container.get('fs');\n    const fileName = srcFileName || 'model.nlp';\n    const data = await fs.readFile(fileName);\n    if (data) {\n      this.import(data);\n      return true;\n    }\n    return false;\n  }\n}\n\nmodule.exports = Nlp;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}