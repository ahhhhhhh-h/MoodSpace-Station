{"ast":null,"code":"/*\n * Copyright (c) AXA Group Operations Spain S.A.\n *\n * Permission is hereby granted, free of charge, to any person obtaining\n * a copy of this software and associated documentation files (the\n * \"Software\"), to deal in the Software without restriction, including\n * without limitation the rights to use, copy, modify, merge, publish,\n * distribute, sublicense, and/or sell copies of the Software, and to\n * permit persons to whom the Software is furnished to do so, subject to\n * the following conditions:\n *\n * The above copyright notice and this permission notice shall be\n * included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\n * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\n * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\nconst {\n  Clonable\n} = require('@nlpjs/core');\nconst dataName = '_data';\nclass ContextManager extends Clonable {\n  constructor(settings = {}, container) {\n    super({\n      settings: {},\n      container: settings.container || container\n    }, container);\n    this.applySettings(this.settings, settings);\n    if (!this.settings.tag) {\n      this.settings.tag = `context-manager`;\n    }\n    this.registerDefault();\n    this.applySettings(this.settings, this.container.getConfiguration(this.settings.tag));\n    this.contextDictionary = {};\n    this.defaultData = {};\n  }\n  registerDefault() {\n    this.container.registerConfiguration('context-manager', {\n      tableName: 'context'\n    });\n  }\n  async getInputContextId(input) {\n    let result;\n    if (this.onGetInputContextId) {\n      result = await this.onGetInputContextId(input);\n    }\n    if (!result && input && input.activity) {\n      if (input.activity.address && input.activity.address.conversation) {\n        result = input.activity.address.conversation.id;\n      } else if (input.activity.conversation) {\n        result = input.activity.conversation.id;\n      }\n    }\n    return result;\n  }\n  async getContext(input) {\n    const id = await this.getInputContextId(input);\n    let result;\n    if (id) {\n      if (this.settings.tableName) {\n        const database = this.container ? this.container.get('database') : undefined;\n        if (database) {\n          result = (await database.findOne(this.settings.tableName, {\n            conversationId: id\n          })) || {\n            conversationId: id\n          };\n        }\n      }\n      if (!result) {\n        result = this.contextDictionary[id] || {\n          conversationId: id\n        };\n      }\n    } else {\n      result = {};\n    }\n    result[dataName] = this.defaultData;\n    return result;\n  }\n  async setContext(input, context) {\n    const logger = this.container.get('logger');\n    const id = await this.getInputContextId(input);\n    if (id) {\n      if (!context.id) {\n        const savedContext = await this.getContext(input);\n        if (savedContext) {\n          context.id = savedContext.id;\n        }\n      }\n      const keys = Object.keys(context);\n      const clone = {\n        conversationId: id\n      };\n      for (let i = 0; i < keys.length; i += 1) {\n        const key = keys[i];\n        if (!key.startsWith('_')) {\n          clone[key] = context[key];\n        }\n      }\n      if (this.settings.tableName) {\n        const database = this.container ? this.container.get('database') : undefined;\n        if (database) {\n          await database.save(this.settings.tableName, clone);\n        } else {\n          this.contextDictionary[id] = clone;\n        }\n      } else {\n        this.contextDictionary[id] = clone;\n      }\n      if (this.onCtxUpdate) {\n        logger.debug(`emmitting event onCtxUpdate...`);\n        await this.onCtxUpdate(clone);\n      }\n    }\n  }\n  async resetConversations() {\n    for (const cid of Object.keys(this.contextDictionary)) {\n      await this.resetConversation(cid);\n    }\n  }\n  async resetConversation(cid) {\n    const logger = this.container.get('logger');\n    logger.debug(`resetting context in conversation: ${cid}`);\n    const conversationCtx = this.contextDictionary[cid];\n    Object.keys(conversationCtx).forEach(convCtxKey => {\n      delete conversationCtx[convCtxKey];\n    });\n    this.contextDictionary[cid].dialogStack = [];\n    this.contextDictionary[cid].variableName = undefined;\n  }\n}\nmodule.exports = ContextManager;","map":{"version":3,"names":["Clonable","require","dataName","ContextManager","constructor","settings","container","applySettings","tag","registerDefault","getConfiguration","contextDictionary","defaultData","registerConfiguration","tableName","getInputContextId","input","result","onGetInputContextId","activity","address","conversation","id","getContext","database","get","undefined","findOne","conversationId","setContext","context","logger","savedContext","keys","Object","clone","i","length","key","startsWith","save","onCtxUpdate","debug","resetConversations","cid","resetConversation","conversationCtx","forEach","convCtxKey","dialogStack","variableName","module","exports"],"sources":["/Users/zyq/Desktop/大二下/暑期实习/moonshot project/node_modules/@nlpjs/nlp/src/context-manager.js"],"sourcesContent":["/*\n * Copyright (c) AXA Group Operations Spain S.A.\n *\n * Permission is hereby granted, free of charge, to any person obtaining\n * a copy of this software and associated documentation files (the\n * \"Software\"), to deal in the Software without restriction, including\n * without limitation the rights to use, copy, modify, merge, publish,\n * distribute, sublicense, and/or sell copies of the Software, and to\n * permit persons to whom the Software is furnished to do so, subject to\n * the following conditions:\n *\n * The above copyright notice and this permission notice shall be\n * included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\n * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\n * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\nconst { Clonable } = require('@nlpjs/core');\n\nconst dataName = '_data';\n\nclass ContextManager extends Clonable {\n  constructor(settings = {}, container) {\n    super(\n      { settings: {}, container: settings.container || container },\n      container\n    );\n    this.applySettings(this.settings, settings);\n    if (!this.settings.tag) {\n      this.settings.tag = `context-manager`;\n    }\n    this.registerDefault();\n    this.applySettings(\n      this.settings,\n      this.container.getConfiguration(this.settings.tag)\n    );\n    this.contextDictionary = {};\n    this.defaultData = {};\n  }\n\n  registerDefault() {\n    this.container.registerConfiguration('context-manager', {\n      tableName: 'context',\n    });\n  }\n\n  async getInputContextId(input) {\n    let result;\n    if (this.onGetInputContextId) {\n      result = await this.onGetInputContextId(input);\n    }\n    if (!result && input && input.activity) {\n      if (input.activity.address && input.activity.address.conversation) {\n        result = input.activity.address.conversation.id;\n      } else if (input.activity.conversation) {\n        result = input.activity.conversation.id;\n      }\n    }\n    return result;\n  }\n\n  async getContext(input) {\n    const id = await this.getInputContextId(input);\n    let result;\n    if (id) {\n      if (this.settings.tableName) {\n        const database = this.container\n          ? this.container.get('database')\n          : undefined;\n        if (database) {\n          result = (await database.findOne(this.settings.tableName, {\n            conversationId: id,\n          })) || { conversationId: id };\n        }\n      }\n      if (!result) {\n        result = this.contextDictionary[id] || { conversationId: id };\n      }\n    } else {\n      result = {};\n    }\n    result[dataName] = this.defaultData;\n    return result;\n  }\n\n  async setContext(input, context) {\n    const logger = this.container.get('logger');\n    const id = await this.getInputContextId(input);\n    if (id) {\n      if (!context.id) {\n        const savedContext = await this.getContext(input);\n        if (savedContext) {\n          context.id = savedContext.id;\n        }\n      }\n      const keys = Object.keys(context);\n      const clone = { conversationId: id };\n      for (let i = 0; i < keys.length; i += 1) {\n        const key = keys[i];\n        if (!key.startsWith('_')) {\n          clone[key] = context[key];\n        }\n      }\n      if (this.settings.tableName) {\n        const database = this.container\n          ? this.container.get('database')\n          : undefined;\n        if (database) {\n          await database.save(this.settings.tableName, clone);\n        } else {\n          this.contextDictionary[id] = clone;\n        }\n      } else {\n        this.contextDictionary[id] = clone;\n      }\n      if (this.onCtxUpdate) {\n        logger.debug(`emmitting event onCtxUpdate...`);\n        await this.onCtxUpdate(clone);\n      }\n    }\n  }\n\n  async resetConversations() {\n    for (const cid of Object.keys(this.contextDictionary)) {\n      await this.resetConversation(cid);\n    }\n  }\n\n  async resetConversation(cid) {\n    const logger = this.container.get('logger');\n    logger.debug(`resetting context in conversation: ${cid}`);\n    const conversationCtx = this.contextDictionary[cid];\n    Object.keys(conversationCtx).forEach((convCtxKey) => {\n      delete conversationCtx[convCtxKey];\n    });\n    this.contextDictionary[cid].dialogStack = [];\n    this.contextDictionary[cid].variableName = undefined;\n  }\n}\n\nmodule.exports = ContextManager;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}